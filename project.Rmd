```{r intersect, eval=FALSE}
#install.packages("leaflet")
#install.packages("sf")
library(leaflet)
library(sf)
library(dplyr)
```

```{r intersect, eval=FALSE}
# Read and prepare the first layer
path <- file.path("data/park_groent_omr_oversigtskortPolygon.shp")
layer1 <- st_read(path)
layer1 <- st_transform(layer1, crs = "+init=epsg:25832")

layer1 <- st_transform(layer1, "+proj=longlat +datum=WGS84")

# Check the CRS of the transformed layer
st_crs(layer1)

```

```{r intersect, eval=FALSE}
# Create a leaflet map
map <- leaflet() %>%
  setView(lng =12.565671 , lat = 55.684818, zoom = 12) %>%
  addTiles()

map
```

```{r intersect, eval=FALSE}
# Add the first layer to the map
map <- map %>% addPolygons(data = layer1, color = "green", fill = "green", weight = 2)

```

```{r intersect, eval=FALSE}
# Display the map
map
```

```{r intersect, eval=FALSE}
# Display the map
path <- file.path("data/skolegrunddistriktPolygon.shp")
layer2 <- st_read(path)
layer2 <- st_transform(layer2, crs = "+init=epsg:25832")

layer2 <- st_transform(layer2, "+proj=longlat +datum=WGS84")

# Check the CRS of the transformed layer
st_crs(layer2)
```

```{r intersect, eval=FALSE}
map <- map %>% addPolygons(data = layer2, color = "red", fill= "blue", weight = 2)
map
```

```{r intersect, eval=FALSE}
map <- map %>%
  htmlwidgets::onRender("
    function(el, x) {
      var layer1 = L.layerGroup();
      var layer2 = L.layerGroup();

      // Add the first layer polygons to the layer group
      x.layer1.eachLayer(function(layer) {
        layer1.addLayer(layer);
      });

      // Add the second layer polygons to the layer group
      x.layer2.eachLayer(function(layer) {
        layer2.addLayer(layer);
      });

      // Initialize the Spiderfier plugin
      var spiderfier = new L.MarkerClusterGroup.Spiderfier();

      // Add the layer groups to the Spiderfier plugin
      spiderfier.addLayers([layer1, layer2]);

      // Bind the 'spiderfierclick' event to handle overlapping polygons
      spiderfier.on('spiderfierclick', function(event) {
        var spiderfiedLayer = event.layer;

        // Get the number of overlapping polygons for the clicked layer
        var overlappingCount = spiderfiedLayer.getAllChildMarkers().length;

        // Show the number of overlapping polygons in an alert
        print('Number of overlapping polygons: ' + overlappingCount);
      });

      // Add the Spiderfier plugin to the map
      map.addLayer(spiderfier);
    }
  ")

# Display the map
map
```

```{r}
library(dplyr)

# Fix the geometry problems
green <- st_make_valid(layer1)
schools <- st_make_valid(layer2)

# Perform the spatial overlay and join the attribute data
intersection <- st_intersection(schools, green)

#dataset with number of overlaps
dataset <- table(intersection$id)
```
```{r}
df1 <- data.frame(
  id = c(1:56),
  freq = c(54, 22, 22, 12, 9, 1, 18, 8, 8, 8, 10, 11, 15, 10, 12, 11, 56, 17, 0,  9, 33, 7, 41, 11, 17, 46, 9, 33, 17, 45, 60, 24, 12, 3, 8, 28, 4, 4, 36, 5, 17, 35, 2, 22, 56, 1, 20, 17, 27, 29, 18, 35, 5, 37, 7, 70)
)
```

```{r}
# Perform the join based on the 'id' column
joined_data <- schools %>%
  inner_join(df1, by = c("id" = "id"))

# Print the joined data
parks_per_district <- subset(joined_data, select = c("park_freq", "enhedsnavn"))

parks_per_district
```

```{r}
map <- map %>% addPolygons(data = joined_data, color = "red", fill= "blue", weight = 2, label=joined_data$freq)
map
```
